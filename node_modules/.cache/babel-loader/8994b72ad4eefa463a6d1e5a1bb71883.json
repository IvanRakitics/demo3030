{"ast":null,"code":"import { __awaiter } from \"tslib\";\nimport React, { useRef, useState } from 'react';\nimport { AddOutline } from 'antd-mobile-icons';\nimport { mergeProps } from '../../utils/with-default-props';\nimport ImageViewer from '../image-viewer';\nimport PreviewItem from './preview-item';\nimport { usePropsValue } from '../../utils/use-props-value';\nimport { useIsomorphicLayoutEffect, useMemoizedFn, useUnmount } from 'ahooks';\nimport Space from '../space';\nimport { withNativeProps } from '../../utils/native-props';\nconst classPrefix = `adm-image-uploader`;\nconst defaultProps = {\n  disableUpload: false,\n  deletable: true,\n  showUpload: true,\n  multiple: false,\n  maxCount: 0,\n  defaultValue: [],\n  accept: 'image/*',\n  preview: true,\n  showFailed: true\n};\nexport const ImageUploader = p => {\n  const props = mergeProps(defaultProps, p);\n  const [value, setValue] = usePropsValue(props);\n  const updateValue = useMemoizedFn(updater => {\n    setValue(updater(value));\n  });\n  const [tasks, setTasks] = useState([]);\n  useIsomorphicLayoutEffect(() => {\n    setTasks(prev => prev.filter(task => {\n      if (task.url === undefined) return true;\n      return !value.some(fileItem => fileItem.url === task.url);\n    }));\n  }, [value]);\n  const idCountRef = useRef(0);\n  const {\n    maxCount,\n    onPreview\n  } = props;\n\n  function processFile(file, fileList) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const {\n        beforeUpload\n      } = props;\n      let transformedFile = file;\n      transformedFile = yield beforeUpload === null || beforeUpload === void 0 ? void 0 : beforeUpload(file, fileList);\n      return transformedFile;\n    });\n  }\n\n  function onChange(e) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function* () {\n      e.persist();\n      const {\n        files: rawFiles\n      } = e.target;\n      if (!rawFiles) return;\n      let files = [].slice.call(rawFiles);\n\n      if (props.beforeUpload) {\n        const postFiles = files.map(file => {\n          return processFile(file, files);\n        });\n        yield Promise.all(postFiles).then(filesList => {\n          files = filesList.filter(Boolean);\n        });\n      }\n\n      if (files.length === 0) {\n        return;\n      }\n\n      if (maxCount > 0) {\n        const exceed = value.length + files.length - maxCount;\n\n        if (exceed > 0) {\n          files = files.slice(0, files.length - exceed);\n          (_a = props.onCountExceed) === null || _a === void 0 ? void 0 : _a.call(props, exceed);\n        }\n      }\n\n      const newTasks = files.map(file => ({\n        id: idCountRef.current++,\n        status: 'pending',\n        file\n      }));\n      setTasks(prev => [...prev, ...newTasks]);\n      yield Promise.all(newTasks.map(currentTask => __awaiter(this, void 0, void 0, function* () {\n        try {\n          const result = yield props.upload(currentTask.file);\n          setTasks(prev => {\n            return prev.map(task => {\n              if (task.id === currentTask.id) {\n                return Object.assign(Object.assign({}, task), {\n                  url: result.url\n                });\n              }\n\n              return task;\n            });\n          });\n          updateValue(prev => {\n            const newVal = Object.assign({}, result);\n            return [...prev, newVal];\n          });\n        } catch (e) {\n          setTasks(prev => {\n            return prev.map(task => {\n              if (task.id === currentTask.id) {\n                return Object.assign(Object.assign({}, task), {\n                  status: 'fail'\n                });\n              }\n\n              return task;\n            });\n          });\n          throw e;\n        }\n      }))).catch(error => console.error(error));\n      e.target.value = ''; // HACK: fix the same file doesn't trigger onChange\n    });\n  }\n\n  const imageViewerHandlerRef = useRef(null);\n\n  function previewImage(index) {\n    imageViewerHandlerRef.current = ImageViewer.Multi.show({\n      images: value.map(fileItem => fileItem.url),\n      defaultIndex: index,\n      onClose: () => {\n        imageViewerHandlerRef.current = null;\n      }\n    });\n  }\n\n  useUnmount(() => {\n    var _a;\n\n    (_a = imageViewerHandlerRef.current) === null || _a === void 0 ? void 0 : _a.close();\n  });\n  const showUpload = props.showUpload && (maxCount === 0 || value.length + tasks.length < maxCount);\n  return withNativeProps(props, React.createElement(\"div\", {\n    className: classPrefix\n  }, React.createElement(Space, {\n    className: `${classPrefix}-space`,\n    wrap: true,\n    block: true\n  }, value.map((fileItem, index) => {\n    var _a, _b;\n\n    return React.createElement(PreviewItem, {\n      key: (_a = fileItem.key) !== null && _a !== void 0 ? _a : index,\n      url: (_b = fileItem.thumbnailUrl) !== null && _b !== void 0 ? _b : fileItem.url,\n      deletable: props.deletable,\n      onClick: () => {\n        if (props.preview) {\n          previewImage(index);\n        }\n\n        onPreview && onPreview(index, fileItem);\n      },\n      onDelete: () => __awaiter(void 0, void 0, void 0, function* () {\n        var _c;\n\n        const canDelete = yield (_c = props.onDelete) === null || _c === void 0 ? void 0 : _c.call(props, fileItem);\n        if (canDelete === false) return;\n        setValue(value.filter((x, i) => i !== index));\n      })\n    });\n  }), tasks.map(task => {\n    if (!props.showFailed && task.status === 'fail') {\n      return null;\n    }\n\n    return React.createElement(PreviewItem, {\n      key: task.id,\n      file: task.file,\n      deletable: task.status !== 'pending',\n      status: task.status,\n      onDelete: () => {\n        setTasks(tasks.filter(x => x.id !== task.id));\n      }\n    });\n  }), showUpload && React.createElement(\"div\", {\n    className: `${classPrefix}-upload-button-wrap`\n  }, props.children ? props.children : React.createElement(\"span\", {\n    className: `${classPrefix}-cell ${classPrefix}-upload-button`,\n    role: 'button'\n  }, React.createElement(\"span\", {\n    className: `${classPrefix}-upload-button-icon`\n  }, React.createElement(AddOutline, null))), !props.disableUpload && React.createElement(\"input\", {\n    capture: props.capture,\n    accept: props.accept,\n    multiple: props.multiple,\n    type: 'file',\n    className: `${classPrefix}-input`,\n    onChange: onChange\n  })))));\n};","map":{"version":3,"sources":["D:/react/project0330/node_modules/antd-mobile/es/components/image-uploader/image-uploader.js"],"names":["__awaiter","React","useRef","useState","AddOutline","mergeProps","ImageViewer","PreviewItem","usePropsValue","useIsomorphicLayoutEffect","useMemoizedFn","useUnmount","Space","withNativeProps","classPrefix","defaultProps","disableUpload","deletable","showUpload","multiple","maxCount","defaultValue","accept","preview","showFailed","ImageUploader","p","props","value","setValue","updateValue","updater","tasks","setTasks","prev","filter","task","url","undefined","some","fileItem","idCountRef","onPreview","processFile","file","fileList","beforeUpload","transformedFile","onChange","e","_a","persist","files","rawFiles","target","slice","call","postFiles","map","Promise","all","then","filesList","Boolean","length","exceed","onCountExceed","newTasks","id","current","status","currentTask","result","upload","Object","assign","newVal","catch","error","console","imageViewerHandlerRef","previewImage","index","Multi","show","images","defaultIndex","onClose","close","createElement","className","wrap","block","_b","key","thumbnailUrl","onClick","onDelete","_c","canDelete","x","i","children","role","capture","type"],"mappings":"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","sourcesContent":["import { __awaiter } from \"tslib\";\nimport React, { useRef, useState } from 'react';\nimport { AddOutline } from 'antd-mobile-icons';\nimport { mergeProps } from '../../utils/with-default-props';\nimport ImageViewer from '../image-viewer';\nimport PreviewItem from './preview-item';\nimport { usePropsValue } from '../../utils/use-props-value';\nimport { useIsomorphicLayoutEffect, useMemoizedFn, useUnmount } from 'ahooks';\nimport Space from '../space';\nimport { withNativeProps } from '../../utils/native-props';\nconst classPrefix = `adm-image-uploader`;\nconst defaultProps = {\n  disableUpload: false,\n  deletable: true,\n  showUpload: true,\n  multiple: false,\n  maxCount: 0,\n  defaultValue: [],\n  accept: 'image/*',\n  preview: true,\n  showFailed: true\n};\nexport const ImageUploader = p => {\n  const props = mergeProps(defaultProps, p);\n  const [value, setValue] = usePropsValue(props);\n  const updateValue = useMemoizedFn(updater => {\n    setValue(updater(value));\n  });\n  const [tasks, setTasks] = useState([]);\n  useIsomorphicLayoutEffect(() => {\n    setTasks(prev => prev.filter(task => {\n      if (task.url === undefined) return true;\n      return !value.some(fileItem => fileItem.url === task.url);\n    }));\n  }, [value]);\n  const idCountRef = useRef(0);\n  const {\n    maxCount,\n    onPreview\n  } = props;\n\n  function processFile(file, fileList) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const {\n        beforeUpload\n      } = props;\n      let transformedFile = file;\n      transformedFile = yield beforeUpload === null || beforeUpload === void 0 ? void 0 : beforeUpload(file, fileList);\n      return transformedFile;\n    });\n  }\n\n  function onChange(e) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function* () {\n      e.persist();\n      const {\n        files: rawFiles\n      } = e.target;\n      if (!rawFiles) return;\n      let files = [].slice.call(rawFiles);\n\n      if (props.beforeUpload) {\n        const postFiles = files.map(file => {\n          return processFile(file, files);\n        });\n        yield Promise.all(postFiles).then(filesList => {\n          files = filesList.filter(Boolean);\n        });\n      }\n\n      if (files.length === 0) {\n        return;\n      }\n\n      if (maxCount > 0) {\n        const exceed = value.length + files.length - maxCount;\n\n        if (exceed > 0) {\n          files = files.slice(0, files.length - exceed);\n          (_a = props.onCountExceed) === null || _a === void 0 ? void 0 : _a.call(props, exceed);\n        }\n      }\n\n      const newTasks = files.map(file => ({\n        id: idCountRef.current++,\n        status: 'pending',\n        file\n      }));\n      setTasks(prev => [...prev, ...newTasks]);\n      yield Promise.all(newTasks.map(currentTask => __awaiter(this, void 0, void 0, function* () {\n        try {\n          const result = yield props.upload(currentTask.file);\n          setTasks(prev => {\n            return prev.map(task => {\n              if (task.id === currentTask.id) {\n                return Object.assign(Object.assign({}, task), {\n                  url: result.url\n                });\n              }\n\n              return task;\n            });\n          });\n          updateValue(prev => {\n            const newVal = Object.assign({}, result);\n            return [...prev, newVal];\n          });\n        } catch (e) {\n          setTasks(prev => {\n            return prev.map(task => {\n              if (task.id === currentTask.id) {\n                return Object.assign(Object.assign({}, task), {\n                  status: 'fail'\n                });\n              }\n\n              return task;\n            });\n          });\n          throw e;\n        }\n      }))).catch(error => console.error(error));\n      e.target.value = ''; // HACK: fix the same file doesn't trigger onChange\n    });\n  }\n\n  const imageViewerHandlerRef = useRef(null);\n\n  function previewImage(index) {\n    imageViewerHandlerRef.current = ImageViewer.Multi.show({\n      images: value.map(fileItem => fileItem.url),\n      defaultIndex: index,\n      onClose: () => {\n        imageViewerHandlerRef.current = null;\n      }\n    });\n  }\n\n  useUnmount(() => {\n    var _a;\n\n    (_a = imageViewerHandlerRef.current) === null || _a === void 0 ? void 0 : _a.close();\n  });\n  const showUpload = props.showUpload && (maxCount === 0 || value.length + tasks.length < maxCount);\n  return withNativeProps(props, React.createElement(\"div\", {\n    className: classPrefix\n  }, React.createElement(Space, {\n    className: `${classPrefix}-space`,\n    wrap: true,\n    block: true\n  }, value.map((fileItem, index) => {\n    var _a, _b;\n\n    return React.createElement(PreviewItem, {\n      key: (_a = fileItem.key) !== null && _a !== void 0 ? _a : index,\n      url: (_b = fileItem.thumbnailUrl) !== null && _b !== void 0 ? _b : fileItem.url,\n      deletable: props.deletable,\n      onClick: () => {\n        if (props.preview) {\n          previewImage(index);\n        }\n\n        onPreview && onPreview(index, fileItem);\n      },\n      onDelete: () => __awaiter(void 0, void 0, void 0, function* () {\n        var _c;\n\n        const canDelete = yield (_c = props.onDelete) === null || _c === void 0 ? void 0 : _c.call(props, fileItem);\n        if (canDelete === false) return;\n        setValue(value.filter((x, i) => i !== index));\n      })\n    });\n  }), tasks.map(task => {\n    if (!props.showFailed && task.status === 'fail') {\n      return null;\n    }\n\n    return React.createElement(PreviewItem, {\n      key: task.id,\n      file: task.file,\n      deletable: task.status !== 'pending',\n      status: task.status,\n      onDelete: () => {\n        setTasks(tasks.filter(x => x.id !== task.id));\n      }\n    });\n  }), showUpload && React.createElement(\"div\", {\n    className: `${classPrefix}-upload-button-wrap`\n  }, props.children ? props.children : React.createElement(\"span\", {\n    className: `${classPrefix}-cell ${classPrefix}-upload-button`,\n    role: 'button'\n  }, React.createElement(\"span\", {\n    className: `${classPrefix}-upload-button-icon`\n  }, React.createElement(AddOutline, null))), !props.disableUpload && React.createElement(\"input\", {\n    capture: props.capture,\n    accept: props.accept,\n    multiple: props.multiple,\n    type: 'file',\n    className: `${classPrefix}-input`,\n    onChange: onChange\n  })))));\n};"]},"metadata":{},"sourceType":"module"}